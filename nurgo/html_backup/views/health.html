<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="utf-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
   <title>Health</title>
   <link rel="stylesheet" href="/css/bootstrap.min.css">
   <script src="/js/jquery.min.js"></script>
   <script src="/js/owl.carousel.js"></script>
   <link rel="stylesheet" href="/css/style.css">
   <link rel="stylesheet" href="/css/responsive.css">
   <link rel="icon" href="/images/fevicon.png" type="image/gif" />
   <link rel="stylesheet" href="/css/jquery.mCustomScrollbar.min.css">
   <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
   <link rel="stylesheet" href="/css/owl.carousel.min.css">
   <link rel="stylesheet" href="/css/owl.theme.default.min.css">
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/2.1.5/jquery.fancybox.min.css"
      media="screen">
   <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
   <script src="/socket.io/socket.io.js"></script>

   <style>
      /* Navbar fijo */
      .header_section .navbar {
         position: sticky;
         top: 0;
         z-index: 1000;
         box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
      }

      .header_section .navbar {
         border-bottom: none;
         /* Quita cualquier borde */
         box-shadow: none;
         /* Quita sombra si hubiera */
         position: sticky;
         /* Hace que el navbar quede fijo al scrollear */
         top: 0;
         z-index: 9999;
      }

      /* Dashboard ajustes m√≠nimos */
      .datos-realtime {
         display: flex;
         flex-wrap: wrap;
         justify-content: center;
         gap: 20px;
         margin-bottom: 20px;
         font-size: 1.2rem;
      }

      .datos-realtime .btn {
         margin-top: 0.5rem;
      }

      .graficos-realtime {
         display: flex;
         flex-wrap: wrap;
         justify-content: center;
         gap: 20px;
      }

      .graficos-realtime canvas {
         background-color: #fff;
         border: 1px solid #ddd;
         padding: 10px;
         border-radius: 8px;
         width: 100%;
         max-width: 480px;
         height: 250px;
      }

      /* Bot√≥n ver mediciones alineado debajo de los gr√°ficos */
      .btn-ver-mediciones {
         display: block;
         margin: 20px auto 0 auto;
      }
   </style>
</head>

<body>
   <!-- header section start -->
   <div class="header_section">
      <nav class="navbar navbar-expand-lg navbar-light bg-light">
         <div class="logo">
            <a href="/index.html"><img src="/images/lesion-de-rodilla.png" height="50" width="55"></a>
         </div>
         <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent">
            <span class="navbar-toggler-icon"></span>
         </button>
         <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mr-auto">
               <li class="nav-item"><a class="nav-link" href="/index.html">Home</a></li>
               <li class="nav-item"><a class="nav-link" href="/medicine.html">Registro</a></li>
               <li class="nav-item active"><a class="nav-link" href="/health.html">Terapia</a></li>
            </ul>
         </div>
      </nav>
   </div>
   <!-- header section end -->

   <!-- health section start -->
   <div class="health_section layout_padding">
      <div class="container">
         <h2 class="text-center mb-4">Valores de Medici√≥n</h2>

         <!-- Botones y valores juntos -->
         <div class="datos-realtime">
            <div>Fuerza: <strong><span id="fuerzaValor">--</span> N</strong></div>
            <div>√Ångulo: <strong><span id="anguloValor">--</span> ¬∞</strong></div>
            <button id="btnIniciar" class="btn btn-primary">‚ñ∂ Iniciar</button>
            <button id="btnPausar" class="btn btn-secondary" disabled>‚è∏ Pausar</button>
            <button id="btnDetener" class="btn btn-danger" disabled>‚èπ Detener</button>
            <button id="btnGuardar" class="btn btn-success" disabled>üíæ Guardar</button>
            <a href="mediciones.html" class="btn btn-success">Ver Mediciones</a>
         </div>

         <!-- Gr√°ficos -->
         <div class="graficos-realtime mt-4">
            <canvas id="graficoFuerza"></canvas>
            <canvas id="graficoAngulo"></canvas>
         </div>
      </div>
   </div>
   <!-- health section end -->

   <style>
      /* Ajustes m√≠nimos para los botones y gr√°ficos */
      .datos-realtime {
         display: flex;
         flex-wrap: wrap;
         justify-content: center;
         gap: 10px;
         margin-bottom: 20px;
         font-size: 1.2rem;
      }

      .graficos-realtime {
         display: flex;
         flex-wrap: wrap;
         justify-content: center;
         gap: 20px;
      }

      .graficos-realtime canvas {
         background-color: #fff;
         border: 1px solid #ddd;
         padding: 10px;
         border-radius: 8px;
         width: 100%;
         max-width: 480px;
         height: 250px;
      }

      .datos-realtime .btn,
      .datos-realtime a.btn {
         margin-top: 0.3rem;
      }
   </style>

   <script>
      const tiempoLabels = [];
      const fuerzaData = [];
      const anguloData = [];

      const ctxF = document.getElementById("graficoFuerza").getContext("2d");
      const graficoFuerza = new Chart(ctxF, {
         type: 'line',
         data: { labels: tiempoLabels, datasets: [{ label: 'Fuerza (N)', data: fuerzaData, borderColor: 'blue', backgroundColor: 'rgba(0, 0, 255, 0.1)', tension: 0.3 }] },
         options: { animation: false, scales: { x: { title: { display: true, text: 'Tiempo' } }, y: { title: { display: true, text: 'Fuerza (N)' } } } }
      });

      const ctxA = document.getElementById("graficoAngulo").getContext("2d");
      const graficoAngulo = new Chart(ctxA, {
         type: 'line',
         data: { labels: tiempoLabels, datasets: [{ label: '√Ångulo (¬∞)', data: anguloData, borderColor: 'green', backgroundColor: 'rgba(0, 255, 0, 0.1)', tension: 0.3 }] },
         options: { animation: false, scales: { x: { title: { display: true, text: 'Tiempo' } }, y: { title: { display: true, text: '√Ångulo (¬∞)' } } } }
      });

      const socket = io();
      const fuerzaSpan = document.getElementById("fuerzaValor");
      const anguloSpan = document.getElementById("anguloValor");
      const btnGuardar = document.getElementById("btnGuardar");

      // Buffer de mediciones
      const bufferMediciones = [];

      socket.on("datos_mqtt", data => {
         const ahora = new Date().toLocaleTimeString();
         fuerzaSpan.textContent = data.fuerza.toFixed(2);
         anguloSpan.textContent = data.angulo.toFixed(2);

         bufferMediciones.push({ tiempo: ahora, fuerza: data.fuerza, angulo: data.angulo });
         if (bufferMediciones.length > 10) bufferMediciones.shift();

         tiempoLabels.push(ahora);
         fuerzaData.push(data.fuerza);
         anguloData.push(data.angulo);
         if (tiempoLabels.length > 20) { tiempoLabels.shift(); fuerzaData.shift(); anguloData.shift(); }

         graficoFuerza.update();
         graficoAngulo.update();

         btnGuardar.disabled = bufferMediciones.length === 0;
      });

      function guardarMedicion() {
         if (bufferMediciones.length === 0) { alert('No hay mediciones para guardar'); return; }
         fetch('/api/guardar-mediciones', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mediciones: bufferMediciones })
         })
            .then(res => res.text())
            .then(msg => alert(msg))
            .catch(err => { console.error(err); alert('Error al guardar'); });
      }

      // Botones de control
      const btnIniciar = document.getElementById("btnIniciar");
      const btnPausar = document.getElementById("btnPausar");
      const btnDetener = document.getElementById("btnDetener");
      let medicionActiva = false;
      let pausado = false;

      btnIniciar.addEventListener("click", () => {
         medicionActiva = true; pausado = false;
         btnIniciar.disabled = true; btnPausar.disabled = false; btnDetener.disabled = false;
      });
      btnPausar.addEventListener("click", () => {
         pausado = !pausado;
         btnPausar.textContent = pausado ? "‚ñ∂ Reanudar" : "‚è∏ Pausar";
      });
      btnDetener.addEventListener("click", () => {
         medicionActiva = false; pausado = false;
         btnIniciar.disabled = false; btnPausar.disabled = true; btnDetener.disabled = true;
         btnPausar.textContent = "‚è∏ Pausar";
      });
   </script>