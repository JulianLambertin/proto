<!DOCTYPE html>
<html lang="es">

<head>
    <link rel="icon" type="image/png" href="/icons/engineering.png" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Técnico - KneeCare</title>
    <link rel="stylesheet" href="/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">
    <script src="/js/jquery.min.js"></script>
    <script src="/js/bootstrap.bundle.min.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body {
            background-color: #f4f6f8;
            padding-top: 80px;
            /* Espacio para la barra de navegación fija */
        }

        .container {
            max-width: 1400px;
        }

        .card {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
            padding: 20px !important;
        }

        .sensor-value {
            font-size: 1.6rem;
            font-weight: 700;
            color: #007bff;
        }

        /* Estilos para los 3 botones de actuadores */
        .btn-actuador {
            min-width: 150px;
            font-weight: 600;
            margin-right: 15px;
            margin-bottom: 10px;
        }

        .historial tbody tr:hover {
            background-color: #e6f7f7;
        }

        .badge {
            font-size: 0.85rem;
            font-weight: 700;
        }

        .chip {
            display: inline-block;
            padding: 4px 12px;
            background: #eef6ff;
            border: 1px solid #cfe3ff;
            border-radius: 999px;
            font-size: 0.85rem;
            margin-right: 8px;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .modal textarea {
            min-height: 120px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-dark bg-dark shadow-sm fixed-top">
        <div class="container-fluid container">
            <h2 class="navbar-brand m-0 text-info fw-bold">⚙️ Dashboard Servicio Técnico</h2>
            <a href="/logout" class="btn btn-danger fw-semibold">
                <i class="fa fa-sign-out me-2"></i>Cerrar Sesión
            </a>
        </div>
    </nav>

    <div class="container">

        <div class="card bg-white">
            <h4 class="mb-4 text-primary fw-bold"><i class="fa fa-tachometer me-2"></i> Val. Tiempo Real y Control
            </h4>

            <div class="d-flex flex-column flex-md-row gap-4 align-items-md-center mb-4">
                <div><span class="text-muted">Fuerza:</span> <span id="fuerzaValor" class="sensor-value text-success">--
                        N</span></div>
                <div><span class="text-muted">Ángulo:</span> <span id="anguloValor" class="sensor-value text-primary">--
                        °</span></div>
                <div><span class="text-muted">EMG:</span> <span id="emgValor" class="sensor-value text-danger">--
                        mV</span></div>
            </div>

            <hr class="my-4">

            <h5 class="text-secondary fw-bold mb-3"><i class="fa fa-wrench me-2"></i> Control de Actuadores</h5>
            <div id="actuadoresContainer" class="d-flex flex-wrap">
                <button id="btnRelay" class="btn btn-warning btn-actuador" data-actuador="relay">
                    <i class="fa fa-plug me-2"></i> Relé: OFF
                </button>
                <button id="btnMotor1" class="btn btn-warning btn-actuador" data-actuador="motor1">
                    <i class="fa fa-cogs me-2"></i> Motor 1: OFF
                </button>
                <button id="btnMotor2" class="btn btn-warning btn-actuador" data-actuador="motor2">
                    <i class="fa fa-cogs me-2"></i> Motor 2: OFF
                </button>
            </div>

        </div>

        <hr class="my-4">
        <div class="card bg-white">
            <h4 class="mb-3 text-danger fw-bold"><i class="fa fa-warning me-2"></i> Reportes pendientes de Corrección
            </h4>
            <div class="table-responsive">
                <table class="table table-hover" id="tablaPendientes">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha</th>
                            <th>Emisor</th>
                            <th>Tipo</th>
                            <th>Dispositivo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card bg-white">
            <h4 class="mb-3 text-success fw-bold"><i class="fa fa-clock-o me-2"></i> Historial Rápido (últimos 10 datos)
            </h4>
            <div class="table-responsive">
                <table class="table table-striped historial">
                    <thead>
                        <tr>
                            <th>Tiempo</th>
                            <th>Fuerza (N)</th>
                            <th>Ángulo (°)</th>
                            <th>EMG (mV)</th>
                        </tr>
                    </thead>
                    <tbody id="historial-body"></tbody>
                </table>
            </div>
        </div>

        <hr class="my-4">

        <div class="card bg-white">
            <h4 class="mb-3 text-info fw-bold"><i class="fa fa-history me-2"></i> Historial de Reportes Corregidos</h4>
            <div class="table-responsive">
                <table class="table table-hover" id="tablaHistorial">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Fecha Creación</th>
                            <th>Emisor</th>
                            <th>Rol emisor</th>
                            <th>Tipo</th>
                            <th>Dispositivo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <small id="infoContadorHist" class="text-muted">0 resultados</small>
        </div>

    </div>

    <div class="modal fade" id="modalDetalle" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 id="modalTitulo" class="modal-title fw-bold">Reporte de Falla #</h5>
                    <button class="btn-close btn-close-white" onclick="$('#modalDetalle').modal('hide')"
                        aria-label="Cerrar"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4 d-flex flex-wrap">
                        <div class="chip" id="chipId"></div>
                        <div class="chip" id="chipFecha"></div>
                        <div class="chip" id="chipEstado"></div>
                        <div class="chip" id="chipTipo"></div>
                        <div class="chip" id="chipDispositivo"></div>
                    </div>
                    <div class="mb-4">
                        <label class="fw-bold">Descripción del Reporte (Emisor)</label>
                        <div id="detalleDescripcion" class="border rounded p-3 bg-light" style="min-height: 80px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="fw-bold">Respuesta del Servicio Técnico (Tú)</label>
                        <textarea id="detalleRespuesta" class="form-control"
                            placeholder="Describe diagnóstico, acciones y pruebas realizadas..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button id="btnMarcarCorregido" class="btn btn-success fw-bold">
                        <i class="fa fa-check-square-o me-2"></i> Guardar respuesta y corregir
                    </button>
                    <button class="btn btn-secondary" onclick="$('#modalDetalle').modal('hide')">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ======= Configuración inicial =======
        const socket = io();
        const fuerzaSpan = document.getElementById("fuerzaValor");
        const anguloSpan = document.getElementById("anguloValor");
        const emgSpan = document.getElementById("emgValor");
        const historialBody = document.getElementById("historial-body");

        const actuadores = {
            'relay': { estado: false, btn: document.getElementById("btnRelay") },
            'motor1': { estado: false, btn: document.getElementById("btnMotor1") },
            'motor2': { estado: false, btn: document.getElementById("btnMotor2") }
        };

        const buffer = [];
        let reportes = [];
        let seleccionado = null;

        // Referencias dentro del modal
        const modalTitulo = document.getElementById("modalTitulo");
        const chipId = document.getElementById("chipId");
        const chipFecha = document.getElementById("chipFecha");
        const chipEstado = document.getElementById("chipEstado");
        const chipTipo = document.getElementById("chipTipo");
        const chipDispositivo = document.getElementById("chipDispositivo");
        const detalleDescripcion = document.getElementById("detalleDescripcion");
        const detalleRespuesta = document.getElementById("detalleRespuesta");
        const btnMarcarCorregido = document.getElementById("btnMarcarCorregido");


        // ======= Socket (datos en tiempo real) =======
        socket.on("datos_mqtt", data => {
            try {
                const ahora = new Date().toLocaleTimeString();
                fuerzaSpan.textContent = (data.fuerza ?? 0).toFixed(2) + " N";
                anguloSpan.textContent = (data.angulo ?? 0).toFixed(2) + " °";
                emgSpan.textContent = (data.emg ?? 0).toFixed(2) + " mV";

                // Historial Rápido
                buffer.push({ tiempo: ahora, fuerza: data.fuerza ?? 0, angulo: data.angulo ?? 0, emg: data.emg ?? 0 });
                if (buffer.length > 10) buffer.shift();

                historialBody.innerHTML = "";
                buffer.slice().reverse().forEach(m => {
                    historialBody.innerHTML += `<tr><td>${m.tiempo}</td><td>${m.fuerza.toFixed(2)}</td><td>${m.angulo.toFixed(2)}</td><td>${m.emg.toFixed(2)}</td></tr>`;
                });
            } catch (e) {
                console.error("Error procesando datos MQTT:", e);
            }
        });

        // ======= Actuadores (Nueva Lógica) =======

        // Función genérica para alternar actuadores
        window.toggleActuador = function (actuadorKey) {
            const act = actuadores[actuadorKey];
            if (!act) return;

            act.estado = !act.estado;

            fetch(`/api/actuador/${actuadorKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ estado: act.estado })
            }).then(res => res.text())
                .then(() => {
                    const estadoTexto = act.estado ? 'ON' : 'OFF';
                    act.btn.innerHTML = `<i class="${actuadorKey === 'relay' ? 'fa fa-plug' : 'fa fa-cogs'} me-2"></i> ${actuadorKey.replace('motor', 'Motor ')}: ${estadoTexto}`;
                    act.btn.classList.toggle('btn-success', act.estado);
                    act.btn.classList.toggle('btn-warning', !act.estado);
                }).catch(err => {
                    console.error(`Error actuador ${actuadorKey}:`, err);
                    alert(`Error comunicándose con el actuador ${actuadorKey}`);
                    act.estado = !act.estado; // Revertir el estado local
                });
        };

        // Asignar el listener a los botones de actuadores
        document.getElementById("actuadoresContainer").addEventListener('click', (event) => {
            const btn = event.target.closest('.btn-actuador');
            if (btn) {
                const actuadorKey = btn.getAttribute('data-actuador');
                toggleActuador(actuadorKey);
            }
        });


        // ======= Reportes (funciones de manejo) =======
        function obtenerBadgeEstado(estado) {
            const estadoStr = String(estado).toLowerCase();
            if (estadoStr === 'corregido' || estadoStr === 'solucionado') return '<span class="badge bg-success">✅ Corregido</span>';
            if (estadoStr === 'en_proceso') return '<span class="badge bg-warning text-dark">⏳ En Proceso</span>';
            return '<span class="badge bg-danger">⚠️ Pendiente</span>'; // Por defecto, es pendiente
        }

        async function cargarReportes() {
            try {
                const res = await fetch('/api/reportes', { cache: 'no-store' });
                if (!res.ok) {
                    if (res.status === 403) throw new Error("403: Acceso denegado a reportes. Intenta reiniciar sesión.");
                    throw new Error(`HTTP ${res.status}`);
                }
                reportes = await res.json();
                renderPendientes();
                renderHistorial();
            } catch (err) {
                console.error("Error cargando reportes:", err);
                const msg = `<tr><td colspan="8" class="text-danger">Error al cargar reportes: ${err.message}</td></tr>`;
                document.querySelector("#tablaPendientes tbody").innerHTML = msg;
                document.querySelector("#tablaHistorial tbody").innerHTML = msg;
            }
        }

        function renderPendientes() {
            const tbody = document.querySelector("#tablaPendientes tbody");
            const pendientes = reportes.filter(r => String(r.estado).toLowerCase() === "pendiente" || String(r.estado).toLowerCase() === "en_proceso");
            tbody.innerHTML = "";
            if (pendientes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-muted">No hay reportes pendientes</td></tr>';
                return;
            }

            pendientes.forEach(r => {
                tbody.innerHTML += `
        <tr onclick="abrirCorregir(${r.id})" style="cursor: pointer;">
          <td>${r.id}</td>
          <td>${new Date(r.fecha_creacion).toLocaleString()}</td>
          <td>${r.usuario_emisor ?? ''}</td>
          <td>${r.tipo ?? ''}</td>
          <td>${r.dispositivo ?? ''}</td>
          <td>${obtenerBadgeEstado(r.estado)}</td>
          <td>
            <button class="btn btn-sm btn-info fw-semibold" onclick="event.stopPropagation(); abrirCorregir(${r.id})">
                <i class="fa fa-pencil me-1"></i> Responder
            </button>
          </td>
        </tr>`;
            });
        }

        function renderHistorial() {
            const tbody = document.querySelector("#tablaHistorial tbody");
            const corregidos = reportes.filter(r => String(r.estado).toLowerCase() === "corregido" || String(r.estado).toLowerCase() === "solucionado");

            document.getElementById("infoContadorHist").textContent = `${corregidos.length} resultados`;
            tbody.innerHTML = "";
            if (corregidos.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-muted">Sin reportes corregidos</td></tr>';
                return;
            }

            corregidos.forEach(r => {
                tbody.innerHTML += `
        <tr onclick="verReporte(${r.id})" style="cursor: pointer;">
          <td>${r.id}</td>
          <td>${new Date(r.fecha_creacion).toLocaleString()}</td>
          <td>${r.usuario_emisor ?? ''}</td>
          <td>${r.rol_emisor ?? ''}</td>
          <td>${r.tipo ?? ''}</td>
          <td>${r.dispositivo ?? ''}</td>
          <td>${obtenerBadgeEstado(r.estado)}</td>
          <td>
            <button class="btn btn-sm btn-outline-info" onclick="event.stopPropagation(); verReporte(${r.id})">
                <i class="fa fa-eye"></i> Ver
            </button>
          </td>
        </tr>`;
            });
        }

        // ======= Modal (funciones) =======
        window.verReporte = function (id) {
            seleccionado = reportes.find(r => Number(r.id) === Number(id));
            if (!seleccionado) return alert("Reporte no encontrado en memoria");

            modalTitulo.textContent = `Reporte de Falla #${seleccionado.id}`;
            chipId.textContent = `ID: ${seleccionado.id}`;
            chipFecha.textContent = `Creado: ${new Date(seleccionado.fecha_creacion).toLocaleString()}`;
            chipEstado.innerHTML = obtenerBadgeEstado(seleccionado.estado);
            chipTipo.textContent = `Tipo: ${seleccionado.tipo ?? ''}`;
            chipDispositivo.textContent = `Dispositivo: ${seleccionado.dispositivo ?? ''}`;
            detalleDescripcion.textContent = seleccionado.descripcion ?? "(Sin descripción)";
            detalleRespuesta.value = seleccionado.respuesta ?? "";

            const isCorregido = String(seleccionado.estado).toLowerCase() === 'corregido' || String(seleccionado.estado).toLowerCase() === 'solucionado';

            btnMarcarCorregido.disabled = isCorregido;
            btnMarcarCorregido.textContent = isCorregido ? "✅ Reporte Corregido" : "Guardar respuesta y corregir";
            detalleRespuesta.disabled = isCorregido;

            // Mostrar el modal usando jQuery/Bootstrap
            $('#modalDetalle').modal('show');
        };

        window.abrirCorregir = function (id) {
            verReporte(id);
            // Enfocar el textarea si es un reporte pendiente
            if (seleccionado && (String(seleccionado.estado).toLowerCase() === 'pendiente' || String(seleccionado.estado).toLowerCase() === 'en_proceso')) {
                setTimeout(() => detalleRespuesta.focus(), 300);
            }
        };

        // ======= Corregir (guardar respuesta + marcar) =======
        btnMarcarCorregido.addEventListener("click", async () => {
            if (!seleccionado) return;
            const respuesta = detalleRespuesta.value.trim();
            if (!respuesta) { alert("Escribe una respuesta con el diagnóstico y la corrección realizada."); return; }

            btnMarcarCorregido.disabled = true;
            btnMarcarCorregido.textContent = "Guardando y Marcando...";

            try {
                const res = await fetch(`/api/reportes/${seleccionado.id}/corregir`, {
                    method: "PUT",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ respuesta })
                });
                if (!res.ok) {
                    const txt = await res.text().catch(() => null);
                    throw new Error(`HTTP ${res.status} ${txt || ''}`);
                }

                // Ocultar el modal y refrescar la tabla
                $('#modalDetalle').modal('hide');
                await cargarReportes();
                alert("Reporte corregido y respuesta guardada");
            } catch (err) {
                console.error("Error al corregir:", err);
                alert("No se pudo marcar como corregido. Revisa consola.");
            } finally {
                btnMarcarCorregido.disabled = false;
                btnMarcarCorregido.textContent = "Guardar respuesta y corregir";
            }
        });

        // ======= LÓGICA DE INICIALIZACIÓN (Verificación de Sesión) =======
        function initDashboard() {
            fetch("/session")
                .then(res => {
                    if (!res.ok) throw new Error("Sesión inválida");
                    return res.json();
                })
                .then(sessionData => {
                    const userRol = (sessionData.rol || "").trim().toUpperCase();

                    if (userRol === "SERVICIO_TECNICO") {
                        cargarReportes();
                        // Inicializar el estado de los actuadores si fuera necesario
                    } else {
                        alert("Acceso denegado. Tu rol no es Servicio Técnico.");
                        window.location.href = "/login_rol.html";
                    }
                })
                .catch(error => {
                    console.error("Error en verificación de sesión:", error);
                    alert("Acceso denegado o sesión expirada. Por favor, inicia sesión.");
                    window.location.href = "/login_rol.html";
                });
        }

        document.addEventListener('DOMContentLoaded', initDashboard);

    </script>
</body>

</html>